<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/base :: head}">
    <title>Find Your Reservation - RV Park</title>
</head>
<body>
    <div th:replace="~{layout/base :: nav}"></div>
    
    <main class="container my-5">
        <!-- Header -->
        <div class="row mb-5">
            <div class="col-12 text-center">
                <h1 class="display-4 text-success mb-3">
                    <i class="bi bi-search me-3"></i>Find Your Reservation
                </h1>
                <p class="lead text-muted">Enter your confirmation number or email to view your reservation details</p>
            </div>
        </div>

        <!-- Lookup Form -->
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <div class="card shadow">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-card-text me-2"></i>Reservation Lookup
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="lookupForm">
                            <div class="mb-3">
                                <label for="confirmationNumber" class="form-label">Confirmation Number</label>
                                <input type="text" class="form-control form-control-lg" id="confirmationNumber" 
                                       name="confirmationNumber" placeholder="RV123456789" autocomplete="off">
                                <div class="form-text">Format: RV + numbers (e.g., RV123456789)</div>
                            </div>
                            
                            <div class="text-center my-3">
                                <span class="text-muted">- OR -</span>
                            </div>
                            
                            <div class="mb-4">
                                <label for="email" class="form-label">Email Address</label>
                                <input type="email" class="form-control form-control-lg" id="email" 
                                       name="email" placeholder="john@example.com" autocomplete="email">
                                <div class="form-text">We'll search for reservations using this email</div>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="bi bi-search me-2"></i>Find Reservation
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="row justify-content-center mt-5 d-none" id="resultsSection">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-calendar-check me-2"></i>Reservation Details
                        </h4>
                    </div>
                    <div class="card-body" id="reservationDetails">
                        <!-- Reservation details will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Multiple Results Section -->
        <div class="row justify-content-center mt-5 d-none" id="multipleResultsSection">
            <div class="col-lg-10">
                <div class="card shadow">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-list me-2"></i>Multiple Reservations Found
                        </h4>
                    </div>
                    <div class="card-body">
                        <p class="mb-3">We found multiple reservations associated with this email address:</p>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Confirmation</th>
                                        <th>Dates</th>
                                        <th>Site</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="multipleResultsBody">
                                    <!-- Multiple results will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help Section -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h5 class="card-title text-success">
                            <i class="bi bi-question-circle me-2"></i>Need Help?
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Can't find your reservation?</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check text-success me-2"></i>Double-check your confirmation number</li>
                                    <li><i class="bi bi-check text-success me-2"></i>Try the email address used for booking</li>
                                    <li><i class="bi bi-check text-success me-2"></i>Check your email for confirmation details</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Still need assistance?</h6>
                                <p class="mb-2">
                                    <i class="bi bi-telephone text-success me-2"></i>
                                    <strong>Call us:</strong> (555) 123-CAMP
                                </p>
                                <p class="mb-2">
                                    <i class="bi bi-envelope text-success me-2"></i>
                                    <strong>Email:</strong> info@pineridgerv.com
                                </p>
                                <p class="mb-0">
                                    <i class="bi bi-clock text-success me-2"></i>
                                    <strong>Office Hours:</strong> 8 AM - 6 PM Daily
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div th:replace="~{layout/base :: footer}"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Core JavaScript -->
    <script th:src="@{/js/core/api-service.js}"></script>
    <script th:src="@{/js/core/notification.js}"></script>
    <script th:src="@{/js/core/validation.js}"></script>

    <script>
        class ReservationLookup {
            constructor() {
                this.init();
            }

            init() {
                document.getElementById('lookupForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.searchReservation();
                });

                // Clear form when typing in the other field
                document.getElementById('confirmationNumber').addEventListener('input', () => {
                    document.getElementById('email').value = '';
                });

                document.getElementById('email').addEventListener('input', () => {
                    document.getElementById('confirmationNumber').value = '';
                });
            }

            async searchReservation() {
                const confirmationNumber = document.getElementById('confirmationNumber').value.trim();
                const email = document.getElementById('email').value.trim();

                if (!confirmationNumber && !email) {
                    window.notifications.warning('Please enter either a confirmation number or email address.');
                    return;
                }

                try {
                    window.notifications.info('Searching for your reservation...');
                    this.hideResults();

                    let reservation = null;
                    let multipleReservations = [];

                    if (confirmationNumber) {
                        // Search by confirmation number
                        try {
                            reservation = await api.reservations.getByConfirmation(confirmationNumber);
                        } catch (error) {
                            // Not found, continue to show no results
                        }
                    } else if (email) {
                        // Search by email - this would require a new API endpoint
                        // For now, we'll simulate finding multiple reservations
                        try {
                            const customers = await api.customers.search(email);
                            if (customers.length > 0) {
                                // Get reservations for found customers
                                const allReservations = [];
                                for (const customer of customers) {
                                    const customerReservations = await api.reservations.getByCustomer(customer.id);
                                    allReservations.push(...customerReservations);
                                }

                                if (allReservations.length === 1) {
                                    reservation = allReservations[0];
                                } else if (allReservations.length > 1) {
                                    multipleReservations = allReservations;
                                }
                            }
                        } catch (error) {
                            console.error('Email search error:', error);
                        }
                    }

                    if (reservation) {
                        this.displaySingleReservation(reservation);
                        window.notifications.success('Reservation found!');
                    } else if (multipleReservations.length > 0) {
                        this.displayMultipleReservations(multipleReservations);
                        window.notifications.success(`Found ${multipleReservations.length} reservations.`);
                    } else {
                        window.notifications.error('No reservations found. Please check your information and try again.');
                        this.showNoResults();
                    }

                } catch (error) {
                    console.error('Search error:', error);
                    window.notifications.error('Error searching for reservation. Please try again.');
                }
            }

            displaySingleReservation(reservation) {
                const detailsContainer = document.getElementById('reservationDetails');
                const statusColor = this.getStatusColor(reservation.status);
                const statusText = this.getStatusText(reservation.status);

                detailsContainer.innerHTML = `
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5 class="text-success">Booking Information</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Confirmation Number:</strong></td>
                                    <td>${reservation.confirmationNumber || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Guest Name:</strong></td>
                                    <td>${reservation.customer ? reservation.customer.fullName : 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td><span class="badge bg-${statusColor}">${reservation.status}</span></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-success">Stay Details</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Check-in:</strong></td>
                                    <td>${reservation.startDate || 'N/A'} at 1:00 PM</td>
                                </tr>
                                <tr>
                                    <td><strong>Check-out:</strong></td>
                                    <td>${reservation.endDate || 'N/A'} by 11:00 AM</td>
                                </tr>
                                <tr>
                                    <td><strong>Site:</strong></td>
                                    <td>Site ${reservation.campsite ? reservation.campsite.siteNumber : 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Party Size:</strong></td>
                                    <td>${reservation.partySize || 0} people</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    ${reservation.status === 'CONFIRMED' ? `
                    <div class="alert alert-success">
                        <h6><i class="bi bi-info-circle me-2"></i>Check-in Instructions</h6>
                        <ol class="mb-0">
                            <li>Arrive at 1:00 PM or later on your check-in date</li>
                            <li>Stop by the front office before parking</li>
                            <li>Bring this confirmation and a valid ID</li>
                            <li>ATV passes can be purchased at the gate house</li>
                        </ol>
                    </div>
                    ` : ''}

                    ${reservation.totalAmount ? `
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-success">Payment Summary</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td>Total Amount:</td>
                                    <td class="text-end"><strong>$${reservation.totalAmount}</strong></td>
                                </tr>
                                <tr>
                                    <td>Paid Amount:</td>
                                    <td class="text-end">$${reservation.paidAmount || 0}</td>
                                </tr>
                                <tr class="table-active">
                                    <td><strong>Balance Due:</strong></td>
                                    <td class="text-end"><strong>$${(reservation.totalAmount - (reservation.paidAmount || 0)).toFixed(2)}</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    ` : ''}

                    <div class="mt-4 text-center">
                        ${reservation.status === 'CONFIRMED' || reservation.status === 'CHECKED_IN' ? 
                            '<button class="btn btn-outline-danger me-2" onclick="reservationLookup.cancelReservation()">Cancel Reservation</button>' : ''
                        }
                        <button class="btn btn-success" onclick="window.print()">
                            <i class="bi bi-printer me-2"></i>Print Details
                        </button>
                    </div>
                `;

                document.getElementById('resultsSection').classList.remove('d-none');
            }

            displayMultipleReservations(reservations) {
                const tbody = document.getElementById('multipleResultsBody');
                
                tbody.innerHTML = reservations.map(reservation => `
                    <tr>
                        <td><strong>${reservation.confirmationNumber || 'N/A'}</strong></td>
                        <td>
                            ${reservation.startDate || 'N/A'} to<br>
                            ${reservation.endDate || 'N/A'}
                        </td>
                        <td>Site ${reservation.campsite ? reservation.campsite.siteNumber : 'N/A'}</td>
                        <td>
                            <span class="badge bg-${this.getStatusColor(reservation.status)}">${reservation.status}</span>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="reservationLookup.viewReservation('${reservation.confirmationNumber}')">
                                <i class="bi bi-eye me-1"></i>View
                            </button>
                        </td>
                    </tr>
                `).join('');

                document.getElementById('multipleResultsSection').classList.remove('d-none');
            }

            async viewReservation(confirmationNumber) {
                document.getElementById('confirmationNumber').value = confirmationNumber;
                document.getElementById('email').value = '';
                
                this.hideResults();
                await this.searchReservation();
            }

            cancelReservation() {
                if (confirm('Are you sure you want to cancel this reservation? Cancellation policies apply.')) {
                    window.notifications.info('To cancel your reservation, please call us at (555) 123-CAMP or email info@pineridgerv.com');
                }
            }

            getStatusColor(status) {
                const colors = {
                    'PENDING': 'warning',
                    'CONFIRMED': 'success',
                    'CHECKED_IN': 'primary',
                    'COMPLETED': 'secondary',
                    'CANCELLED': 'danger'
                };
                return colors[status] || 'secondary';
            }

            getStatusText(status) {
                const texts = {
                    'PENDING': 'Payment Pending',
                    'CONFIRMED': 'Confirmed - Visit office before parking',
                    'CHECKED_IN': 'Currently Checked In',
                    'COMPLETED': 'Stay Completed',
                    'CANCELLED': 'Cancelled'
                };
                return texts[status] || status;
            }

            hideResults() {
                document.getElementById('resultsSection').classList.add('d-none');
                document.getElementById('multipleResultsSection').classList.add('d-none');
            }

            showNoResults() {
                // Could show a "no results" message here
                this.hideResults();
            }
        }

        // Initialize lookup when page loads
        document.addEventListener('DOMContentLoaded', function() {
            window.reservationLookup = new ReservationLookup();
        });
    </script>
</body>
</html>